# Training MedCLIP with Indiana University Chest X-ray Dataset

This guide explains how to train MedCLIP using the Indiana University (Open-I) Chest X-ray dataset located in the kaggle folder.

## Dataset Structure

The Indiana dataset is located at:
```
kaggle\input\
├── indiana_projections.csv    # Image filenames and projection types
├── indiana_reports.csv         # Radiology reports and findings
└── images/
    └── images_normalized/      # Chest X-ray images (PNG format)
```

## Step 1: Preprocess the Dataset

First, run the preprocessing script to convert the Indiana dataset into MedCLIP format:

```bash
cd \MedCLIP
python preprocess_indiana.py
```

This script will:
- Load the Indiana dataset CSV files
- Filter to frontal views only (PA/AP projections)
- Map Indiana labels to CheXpert 14-class labels
- Combine findings and impressions into full reports
- Split data into train (80%) and validation (20%) sets
- Save processed data to `local_data/indiana-train-meta.csv` and `local_data/indiana-val-meta.csv`

### Expected Output

The preprocessing creates two CSV files with the following columns:
- `imgpath`: Full path to the image file
- `subject_id`: Patient identifier
- `report`: Combined findings and impression text
- 14 CheXpert label columns: No Finding, Enlarged Cardiomediastinum, Cardiomegaly, etc.

## Step 2: Train the Model

Run the training script:

```bash
python examples/run_indiana_pretrain.py
```

### Training Configuration

The training script uses these settings optimized for the Indiana dataset:
- **Batch size**: 32 (smaller than default due to dataset size)
- **Epochs**: 20 (more epochs for better convergence)
- **Learning rate**: 2e-5
- **Evaluation steps**: 500 (frequent evaluation)
- **Model backbone**: Vision Transformer (ViT)

### Data Augmentation

Applied augmentations:
- Random horizontal flip (50%)
- Color jitter (brightness & contrast)
- Random affine transformations
- Random cropping

## Step 3: Monitor Training

The script will:
- Print training progress every evaluation step
- Save checkpoints to `./checkpoints/indiana_vision_text_pretrain/`
- Evaluate on validation set periodically
- Report metrics (loss, accuracy, etc.)

## Combining with Other Datasets

To train on multiple datasets simultaneously, modify the `datalist` in `run_indiana_pretrain.py`:

```python
datalist = [
    'indiana-train',
    'chexpert-train',  # If available
    'mimic-cxr-train', # If available
]
```

## Label Mapping

The preprocessing script maps Indiana's MeSH terms and Problems to CheXpert labels:

| Indiana Term | CheXpert Label |
|--------------|----------------|
| Cardiomegaly | Cardiomegaly |
| Pulmonary Edema | Edema |
| Pleural Effusion | Pleural Effusion |
| Pneumonia | Pneumonia |
| Atelectasis | Atelectasis |
| Pneumothorax | Pneumothorax |
| Consolidation | Consolidation |
| Opacity | Lung Opacity |
| normal | No Finding |

## Troubleshooting

### Issue: "No such file or directory: ./local_data/indiana-train-meta.csv"
**Solution**: Run `preprocess_indiana.py` first to create the CSV files.

### Issue: Images not found
**Solution**: Verify that images exist at:
`kaggle\input\images\images_normalized\`

### Issue: Out of memory error
**Solution**: Reduce batch_size in `run_indiana_pretrain.py`:
```python
'batch_size': 16,  # or even lower
```

### Issue: CUDA out of memory
**Solution**: 
1. Reduce batch size
2. Or train on CPU by commenting out CUDA setup:
```python
# os.environ['CUDA_VISIBLE_DEVICES']='0'
device = "cpu"
```

## File Structure

```
MedCLIP/
├── preprocess_indiana.py              # Preprocessing script (NEW)
├── examples/
│   ├── run_medclip_pretrain.py       # Original training script
│   └── run_indiana_pretrain.py       # Indiana-specific training (NEW)
├── local_data/
│   ├── indiana-train-meta.csv        # Generated by preprocessing
│   ├── indiana-val-meta.csv          # Generated by preprocessing
│   └── sentence-label.csv            # Required for training
└── checkpoints/
    └── indiana_vision_text_pretrain/ # Training checkpoints
```

## Next Steps

After training:
1. **Evaluate**: Use the saved checkpoints for zero-shot classification
2. **Fine-tune**: Further train on specific downstream tasks
3. **Inference**: Load the model for prediction on new chest X-rays

## Additional Notes

- The Indiana dataset is smaller (~3,000 reports) compared to MIMIC-CXR or CheXpert
- Training may require more epochs to converge well
- Consider data augmentation and combining with other datasets for better performance
- The model uses contrastive learning between images and report text
